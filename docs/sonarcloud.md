# SonarCloud Configuration

## Overview

This project uses SonarCloud for continuous code quality and security analysis. SonarCloud automatically scans the codebase on every push to main/develop branches and on pull requests.

## Features

- **Code Quality**: Detects code smells, bugs, and vulnerabilities
- **Security Analysis**: Identifies security hotspots and vulnerabilities
- **Coverage Tracking**: Monitors test coverage over time
- **Pull Request Decoration**: Shows analysis results directly in GitHub PRs
- **Quality Gate**: Blocks PRs that don't meet quality standards

## Configuration Files

### sonar-project.properties

Main configuration file for SonarCloud:

- **Project Identification**: `sonar.projectKey` and `sonar.organization`
- **Source Paths**: Points to `src/` for source code and `src/tests/` for tests
- **Coverage Path**: Uses `coverage/lcov.info` generated by Vitest
- **Exclusions**: Ignores test files, config files, node_modules, etc.

### .github/workflows/sonarcloud.yml

GitHub Actions workflow that:

1. Runs on push to main/develop and on pull requests
2. Sets up Node.js environment
3. Installs dependencies
4. Runs tests with coverage (`npm run test:coverage`)
5. Executes SonarCloud scan
6. Checks quality gate status

## Setup Instructions

### 1. SonarCloud Account Setup

1. Go to [SonarCloud](https://sonarcloud.io/)
2. Sign in with your GitHub account
3. Import your GitHub repository
4. Note your organization key and project key

### 2. GitHub Repository Configuration

1. Go to your repository settings on GitHub
2. Navigate to Secrets and Variables → Actions
3. Add a new repository secret:
   - Name: `SONAR_TOKEN`
   - Value: Your SonarCloud token (get it from SonarCloud Account → Security)

### 3. SonarCloud Project Configuration

1. In SonarCloud, go to your project
2. Navigate to Administration → Analysis Method
3. Select "GitHub Actions"
4. Follow the provided instructions (most are already configured in this project)

## Running Analysis Locally

You can run SonarCloud analysis locally using the SonarScanner CLI:

```bash
# Install SonarScanner (if not already installed)
npm install -g sonarqube-scanner

# Run tests with coverage first
npm run test:coverage

# Run SonarScanner
sonar-scanner \
  -Dsonar.projectKey=IgorGuariroba_bfin-backend \
  -Dsonar.organization=igorguariroba \
  -Dsonar.sources=src \
  -Dsonar.host.url=https://sonarcloud.io \
  -Dsonar.token=YOUR_SONAR_TOKEN
```

## Understanding Results

### Quality Gate

The quality gate checks:

- **New Code Coverage**: Minimum percentage of new code covered by tests
- **New Bugs**: No new bugs in new code
- **New Vulnerabilities**: No new vulnerabilities in new code
- **New Code Smells**: Limited number of new code smells
- **Security Hotspots**: All security hotspots reviewed

### Metrics

- **Reliability**: Bug count and reliability rating (A-E)
- **Security**: Vulnerability count and security rating (A-E)
- **Maintainability**: Code smell count and maintainability rating (A-E)
- **Coverage**: Percentage of code covered by tests
- **Duplications**: Percentage of duplicated code

## Coverage Integration

This project uses Vitest with LCOV reporter for coverage:

```typescript
// vitest.config.ts
coverage: {
  provider: 'v8',
  reporter: ['text', 'json', 'html', 'lcov'],
  reportsDirectory: './coverage',
}
```

The LCOV report (`coverage/lcov.info`) is automatically uploaded to SonarCloud during CI/CD pipeline execution.

## Exclusions

The following are excluded from analysis:

- `node_modules/**` - Dependencies
- `dist/**` - Build output
- `coverage/**` - Coverage reports
- `**/*.spec.ts`, `**/*.test.ts` - Test files
- `**/tests/**/*` - Test directories
- `**/*.config.ts` - Configuration files
- `**/prisma/migrations/**` - Database migrations
- `**/prisma/seed.ts` - Database seed files
- `**/*.d.ts` - Type definition files

## Troubleshooting

### Coverage Not Showing

If coverage is not showing in SonarCloud:

1. Ensure `npm run test:coverage` runs successfully
2. Check that `coverage/lcov.info` file is generated
3. Verify the path in `sonar-project.properties` matches the LCOV file location
4. Check the GitHub Actions logs for any errors during coverage upload

### Quality Gate Failing

If the quality gate is failing:

1. Check the SonarCloud dashboard for specific issues
2. Review new bugs, vulnerabilities, or code smells introduced
3. Check if coverage decreased below the threshold
4. Fix the issues and push again

### Analysis Not Running

If the analysis is not running:

1. Verify `SONAR_TOKEN` is set in GitHub repository secrets
2. Check that the workflow file is in `.github/workflows/`
3. Ensure the branch name matches the workflow triggers (main/develop)
4. Check GitHub Actions tab for workflow execution logs

## Best Practices

1. **Run Tests Locally**: Always run `npm run test:coverage` before pushing
2. **Check Coverage**: Aim for high test coverage on new code
3. **Fix Issues Early**: Address SonarCloud issues as they appear
4. **Review Security Hotspots**: Review all security hotspots marked by SonarCloud
5. **Monitor Trends**: Use SonarCloud dashboard to monitor quality trends over time

## Useful Commands

```bash
# Run tests with coverage
npm run test:coverage

# View coverage report locally
open coverage/index.html

# Run linting
npm run lint

# Run type checking
npm run type-check

# Run all checks (type-check + lint + format)
npm run check
```

## Resources

- [SonarCloud Documentation](https://docs.sonarcloud.io/)
- [SonarCloud GitHub Action](https://github.com/SonarSource/sonarcloud-github-action)
- [Quality Gate Documentation](https://docs.sonarcloud.io/improving/quality-gates/)
- [Coverage Analysis](https://docs.sonarcloud.io/enriching/test-coverage/overview/)
